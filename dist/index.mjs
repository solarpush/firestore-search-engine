import{HttpsError as t}from"firebase-functions/https";import{Timestamp as e}from"@google-cloud/firestore";class n{constructor(t,e,n){this.firestoreInstance=t,this.config=e,this.props=n,n.wordMaxLength?this.wordMaxLength=n.wordMaxLength:this.wordMaxLength=50,n.wordMinLength?this.wordMinLength=n.wordMinLength:this.wordMinLength=3}async execute(){const t=function(t,e){var n,r;if(t.length>e)throw new Error("Input up to 50 Char");const o=new Set,i=t.length>4?[4,5,6]:[3,4],s={a:["z","q","s"],z:["a","e","s"],e:["z","r","d"],r:["e","t","f"],t:["r","y","g"],y:["t","u","h"],u:["y","i","j"],i:["u","o","k"],o:["i","p","l"],p:["o","m"],q:["a","s","w"],s:["a","z","d","q"],d:["s","e","f"],f:["d","r","g"],g:["f","t","h"],h:["g","y","j"],j:["h","u","k"],k:["j","i","l"],l:["k","o","m"],m:["l","p"]};for(const e of i)for(let i=0;i<=t.length-e;i++){const a=t.slice(i,i+e);if(a.length>=3){const t=a[0];s[t]&&s[t].forEach((t=>{const e=t+a.slice(1);o.add(e.trim())})),null===(n=s[t])||void 0===n||n.forEach((t=>{const e=t+a;o.add(e.trim())})),o.add(a.slice(1).trim())}const c=a[a.length-1];a.length>=3&&s[c]&&(s[c].forEach((t=>{const e=a.slice(0,-1)+t;o.add(e.trim())})),null===(r=s[c])||void 0===r||r.forEach((t=>{const e=a+t;o.add(e.trim())})),o.add(a.slice(0,-1).trim()))}return o}(this.props.inputField,this.wordMaxLength);return await this.saveWithLimitedKeywords(this.props.returnedFields,Array.from(t))}async saveWithLimitedKeywords(t,e){const n=this.firestoreInstance.bulkWriter();await this.cleanOldIndexes(t,n);const r=[];for(let t=0;t<e.length;t+=800)r.push(e.slice(t,t+800));for(let e=0;e<r.length;e++)n.create(this.firestoreInstance.collection(this.config.collection).doc(),{search_keywords:r[e],...t}),e%500==0&&await n.flush();await n.close()}async cleanOldIndexes(t,e){const{indexedDocumentPath:n}=t,r=await this.firestoreInstance.collection(this.config.collection).where("indexedDocumentPath","==",n).get();if(!r.empty){for(let t=0;t<r.docs.length;t++)e.delete(r.docs[t].ref),t%500==0&&await e.flush();await e.flush()}}}function r(t,e){const n=Array.from({length:t.length+1},((t,n)=>[n,...Array(e.length).fill(0)]));for(let t=0;t<=e.length;t++)n[0][t]=t;for(let r=1;r<=t.length;r++)for(let o=1;o<=e.length;o++){const i=t[r-1]===e[o-1]?0:1;n[r][o]=Math.min(n[r-1][o]+1,n[r][o-1]+1,n[r-1][o-1]+i)}return n[t.length][e.length]}class o{constructor(t,e,n){this.firestoreInstance=t,this.config=e,this.props=n,n.limit||(this.props.limit=20)}async execute(){return await this.search(this.props.fieldValue)}async search(t){const e=function(t,e=3,n=8){const r=new Set;t.trim().split(" ").forEach((t=>{for(let o=1;o<=Math.min(t.trim().length,n);o++)o<=e||r.add(t.trim().substring(0,o).toLowerCase())}));for(let o=1;o<=Math.min(t.trim().length,n);o++)o<=e||r.add(t.trim().substring(0,o).toLowerCase());return console.log(r),Array.from(r)}(t),n=await this.firestoreInstance.collection(this.config.collection).where("search_keywords","array-contains-any",[...e]).get();if(n.empty)return[];const o=new Set,i=[];for(const e of n.docs){const n=e.data(),{search_keywords:s,...a}=n,c=n.indexedDocumentPath;s.forEach((e=>{const n=t.split(" ");let s=!1,h=0,l=0;for(const t of n){const n=r(t,e);n<=2&&(s=!0,h=Math.min(n,h||1/0)),l+=n}console.log(l,s,t,n),s&&l<=6&&!o.has(c)&&(o.add(c),i.push({doc:a,relevance:h}))}))}i.sort(((t,e)=>t.relevance-e.relevance));return i.slice(0,this.props.limit).map((t=>t.doc))}}function i(t,n){if(t===n)return!0;if(typeof t!=typeof n)return!1;if(t instanceof e&&n instanceof e)return t.isEqual(n);if(t&&n&&"object"==typeof t&&"object"==typeof n){const e=Object.keys(t),r=Object.keys(n);if(e.length!==r.length)return!1;for(const o of e){if(!r.includes(o))return!1;if(!i(t[o],n[o]))return!1}return!0}return!1}const s=t=>{const e=t.before.data(),n=t.after.data(),r={},o={},s={};Object.keys(n).forEach((t=>{const s=t,a=n[s],c=e[s];void 0===c?o[s]=a:i(a,c)||(r[s]=a)})),Object.keys(e).forEach((t=>{const r=t;void 0===n[r]&&(s[r]=e[r])}));const a={before:e,after:n,changes:r,added:o,removed:s};return console.log("ChangeMap : "+JSON.stringify(r)),a};class a{constructor(t,e){if(this.firestoreInstance=t,this.config=e,this.firestoreInstance.settings({ignoreUndefinedProperties:!0}),this.config.collection.length<1)throw new Error("collectionName is required and must be a non-empty string.")}async search(t){if("string"!=typeof t.fieldValue||0===t.fieldValue.length)throw new Error("fieldValue is required and must be a non-empty string.");return await new o(this.firestoreInstance,this.config,t).execute()}async indexes(t){if("string"!=typeof t.inputField||0===t.inputField.length)throw new Error("fieldValue is required and must be a non-empty string.");return await new n(this.firestoreInstance,this.config,t).execute()}async expressWrapper(t,e="/search"){if(!e||!e.startsWith("/"))throw new Error("Path must be in the format '/search'");return t.get(`${e}/:searchValue`,(async(t,e)=>{const{searchValue:n}=t.params;if(!n||!n.length||n.length<3)return void e.json([]);const r=await this.search({fieldValue:n});e.json(r)})),t}onRequestWrapped(){return async(t,e)=>{const n=t.query.searchValue;if(!n||"string"!=typeof n||n.length<3)return void e.json([]);const r=await this.search({fieldValue:n});e.json(r)}}onCallWrapped(e){return async({data:n,auth:r})=>{if(e){if(!await e(r))throw new t("unauthenticated","Unauthorized")}const o=n.searchValue;if(!o||"string"!=typeof o||o.length<3)return[];return await this.search({fieldValue:o})}}onDocumentWriteWrapper(t,e,n,r={},o={}){return t({...o,document:n},(async t=>{var n,o;const i=null===(n=t.data)||void 0===n?void 0:n.data();if(!t.data||!i)return;const s=i[e.indexedKey],a={};for(const t of e.returnedKey)(i[t]||0===i[t])&&(a[t]=i[t]);if(s&&"string"==typeof s&&s.length>(null!==(o=r.wordMinLength)&&void 0!==o?o:3))try{await this.indexes({...r,inputField:s,returnedFields:{indexedDocumentPath:t.data.ref.path,...a}})}catch(t){return}}))}onDocumentUpdateWrapper(t,e,n,r={},o={}){return t({...o,document:n},(async t=>{var n;if(!t.data)return;const{changes:o,after:i}=s(t.data),a=o[e.indexedKey],c={};for(const t of e.returnedKey)(i[t]||0===i[t])&&(c[t]=i[t]);if(a&&"string"==typeof a&&a.length>(null!==(n=r.wordMinLength)&&void 0!==n?n:3))try{await this.indexes({...r,inputField:a,returnedFields:{indexedDocumentPath:t.data.after.ref.path,...c}})}catch(t){return}}))}onDocumentDeletedWrapper(t,e,n={}){return t({...n,document:e},(async t=>{var e;const n=null===(e=t.data)||void 0===e?void 0:e.data();if(t.data&&n)try{const e=this.firestoreInstance.bulkWriter(),n=t.data.ref.path,r=await this.firestoreInstance.collection(this.config.collection).where("indexedDocumentPath","==",n).get();for(let t=0;t<r.docs.length;t++){const n=r.docs[t];e.delete(n.ref),t%500==0&&await e.flush()}await e.close()}catch(t){return}}))}}export{a as FirestoreSearchEngine};
//# sourceMappingURL=index.mjs.map
