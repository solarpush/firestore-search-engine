{"version":3,"file":"index.cjs","sources":["../src/shared/vectorize.ts","../src/indexes/Indexes.ts","../src/indexes/IndexesAll.ts","../src/shared/levenshteinDistance.ts","../src/search/Search.ts","../src/shared/rankResults.ts","../src/utils/objects/deepEqual.ts","../src/shared/getDiffFromDocumentUpdate.ts","../src/FirestoreSearchEngine.ts"],"sourcesContent":[null,null,null,null,null,null,null,null,null],"names":["async","fse_vectorizeText","text","maxLength","length","documents","embeddings","FlagEmbedding","init","model","EmbeddingModel","AllMiniLML6V2","cacheDir","executionProviders","ExecutionProvider","CPU","embed","vectors","next","finalVector","value","Array","from","Indexes","constructor","firestoreInstance","fieldValueInstance","config","props","this","wordMaxLength","wordMinLength","execute","typos","inputField","saveWithLimitedKeywords","returnedFields","keywords","bulk","bulkWriter","cleanOldIndexes","create","collection","doc","vector","close","indexedDocumentPath","query","where","get","empty","j","docs","delete","ref","flush","IndexesAll","documentProps","documentsToIndexes","readyToBulk","element","indexedKey","fieldValue","toLowerCase","key","returnedKey","push","bulkWithLimitedKeywords","bulkData","bulkCount","document","fse_levenshteinDistance","a","b","matrix","_","i","fill","cost","Math","min","Search","limit","search","queryVector","querySnapshot","collectionGroup","findNearest","vectorField","distanceMeasure","distanceThreshold","distanceResultField","uniqueDocs","Set","results","data","uniqueId","has","add","ranked","map","result","textSimilarityScore","c","d","e","f","g","h","finalScore","reverse","join","distance","sort","fse_rankResults","deepEqual","Timestamp","isEqual","keysA","Object","keys","keysB","includes","getDiffFromUpdatedData","before","after","changes","added","removed","forEach","typedKey","afterValue","beforeValue","undefined","settings","ignoreUndefinedProperties","Error","indexes","indexesAll","docProps","expressWrapper","app","path","startsWith","request","response","searchValue","params","json","onRequestWrapped","req","res","onCallWrapped","authCallBack","auth","HttpsError","onDocumentWriteWrapper","onDocumentWrittenCallBack","documentsPath","eventHandlerOptions","event","_a","updatedFieldValue","_b","error","console","onDocumentUpdateWrapper","instanceOfOnDocumentUpdated","onDocumentDeletedWrapper","instanceOfOnDocumentDeleted","querySnap","index"],"mappings":"mHAOOA,eAAeC,EAAkBC,EAAcC,GACpD,GAAoB,IAAhBD,EAAKE,OAAc,MAAO,GAO9B,IAAIC,EAAY,CAAC,UAAUH,KAC3B,MAAMI,SAPuBC,EAAaA,cAACC,KAAK,CAC9CC,MAAOC,EAAcA,eAACC,cACtBC,SAAU,YACVC,mBAAoB,CAACC,EAAiBA,kBAACC,KACvCZ,UAAWA,KAGqBa,MAAMX,EAAW,GAC7CY,QAAiBX,EAAWY,OAC5BC,GAAcF,aAAA,EAAAA,EAASG,MAAMhB,QAAS,EAAIa,EAAQG,MAAQ,GAChE,OAAOC,MAAMC,KAAKH,EAAY,GAChC,OCGaI,EAGX,WAAAC,CACmBC,EACAC,EACAC,EACAC,GAHAC,KAAiBJ,kBAAjBA,EACAI,KAAkBH,mBAAlBA,EACAG,KAAMF,OAANA,EACAE,KAAKD,MAALA,EAEZC,KAAKF,OAAOG,cAGfD,KAAKC,cAAgBD,KAAKF,OAAOG,cAFjCD,KAAKC,cAAgB,IAIlBD,KAAKF,OAAOI,cAGfF,KAAKE,cAAgBF,KAAKF,OAAOI,cAFjCF,KAAKE,cAAgB,EAMzB,aAAMC,GAEJ,MAAMC,QAAchC,EAClB4B,KAAKD,MAAMM,WACXL,KAAKC,eAEP,aAAaD,KAAKM,wBAAwBN,KAAKD,MAAMQ,eAAgBH,GAG7D,6BAAME,CACdC,EACAC,GAEA,MAAMC,EAAOT,KAAKJ,kBAAkBc,mBAC9BV,KAAKW,gBAAgBJ,EAAgBE,GAE3CA,EAAKG,OACHZ,KAAKJ,kBAAkBiB,WAAWb,KAAKF,OAAOe,YAAYC,MAC1D,CACE1B,QAASY,KAAKH,mBAAmBkB,OAAOP,MACrCD,UAGDE,EAAKO,QAGH,qBAAML,CACdJ,EACAE,GAEA,MAAMQ,oBAAEA,GAAwBV,EAC1BW,QAAclB,KAAKJ,kBACtBiB,WAAWb,KAAKF,OAAOe,YACvBM,MAAM,sBAAuB,KAAMF,GACnCG,MACH,IAAIF,EAAMG,MAAV,CACA,IAAK,IAAIC,EAAI,EAAGA,EAAIJ,EAAMK,KAAKhD,OAAQ+C,IACrCb,EAAKe,OAAON,EAAMK,KAAKD,GAAGG,KACtBH,EAAI,WAAWb,EAAKiB,cAEpBjB,EAAKiB,OALM,SCtDRC,EAGX,WAAAhC,CACmBC,EACAC,EACAC,GAFAE,KAAiBJ,kBAAjBA,EACAI,KAAkBH,mBAAlBA,EACAG,KAAMF,OAANA,EAEZE,KAAKF,OAAOG,cAGfD,KAAKC,cAAgBD,KAAKF,OAAOG,cAFjCD,KAAKC,cAAgB,IAIlBD,KAAKF,OAAOI,cAGfF,KAAKE,cAAgBF,KAAKF,OAAOI,cAFjCF,KAAKE,cAAgB,EAMzB,aAAMC,EAAQyB,cACZA,EAAaC,mBACbA,IAKA,MAAMC,EAGA,GACN,IAAK,SAAWC,KAAaF,EAAoB,CAC/C,MAAMxB,EAAqB0B,EAAQH,EAAcI,YAC3CzB,EACJ,CACEU,oBAAqBc,EAAQd,oBAC7BgB,WAAY5B,EAAW6B,eAE3B,IAAK,MAAMC,KAAOP,EAAcQ,YAC9B7B,EAAe4B,GAAOJ,EAAQI,GAEhC,MAAM/B,QAAchC,EAAkBiC,EAAYL,KAAKC,eACvD6B,EAAYO,KAAK,CACf7B,SAAUJ,EACVG,mBAGJ,aAAaP,KAAKsC,wBAAwBR,GAGlC,6BAAMQ,CACdC,GAKA,MAAM9B,EAAOT,KAAKJ,kBAAkBc,aACpC,IAAI8B,EAAY,EAChB,IAAK,MAAMC,KAAYF,EACjBC,EAAY,KAAS,SACjB/B,EAAKiB,cAEP1B,KAAKW,gBAAgB8B,EAASlC,eAAgBE,EAAM+B,GAC1D/B,EAAKG,OACHZ,KAAKJ,kBAAkBiB,WAAWb,KAAKF,OAAOe,YAAYC,MAC1D,CACE1B,QAASY,KAAKH,mBAAmBkB,OAAO0B,EAASjC,aAC9CiC,EAASlC,iBAGhBiC,IACIA,EAAY,aACR/B,EAAKiB,QACXc,WAGE/B,EAAKO,QAGH,qBAAML,CACdJ,EACAE,EACA+B,GAEA,MAAMvB,oBAAEA,GAAwBV,EAC1BW,QAAclB,KAAKJ,kBACtBiB,WAAWb,KAAKF,OAAOe,YACvBM,MAAM,sBAAuB,KAAMF,GACnCG,MACH,IAAIF,EAAMG,MACV,IAAK,IAAIC,EAAI,EAAGA,EAAIJ,EAAMK,KAAKhD,OAAQ+C,IACrCb,EAAKe,OAAON,EAAMK,KAAKD,GAAGG,OAC1Be,EACgB,YAAY/B,EAAKiB,SC3GvB,SAAAgB,EAAwBC,EAAWC,GACjD,MAAMC,EAASrD,MAAMC,KAAK,CAAElB,OAAQoE,EAAEpE,OAAS,IAAK,CAACuE,EAAGC,IAAM,CAC5DA,KACGvD,MAAMoD,EAAErE,QAAQyE,KAAK,MAE1B,IAAK,IAAI1B,EAAI,EAAGA,GAAKsB,EAAErE,OAAQ+C,IAAKuB,EAAO,GAAGvB,GAAKA,EACnD,IAAK,IAAIyB,EAAI,EAAGA,GAAKJ,EAAEpE,OAAQwE,IAC7B,IAAK,IAAIzB,EAAI,EAAGA,GAAKsB,EAAErE,OAAQ+C,IAAK,CAClC,MAAM2B,EAAON,EAAEI,EAAI,KAAOH,EAAEtB,EAAI,GAAK,EAAI,EACzCuB,EAAOE,GAAGzB,GAAK4B,KAAKC,IAClBN,EAAOE,EAAI,GAAGzB,GAAK,EACnBuB,EAAOE,GAAGzB,EAAI,GAAK,EACnBuB,EAAOE,EAAI,GAAGzB,EAAI,GAAK2B,GAK7B,OAAOJ,EAAOF,EAAEpE,QAAQqE,EAAErE,OAC5B,OCRa6E,EAGX,WAAAzD,CACmBC,EACAE,EACAC,GAFAC,KAAiBJ,kBAAjBA,EACAI,KAAMF,OAANA,EACAE,KAAKD,MAALA,EAEZC,KAAKD,MAAMsD,QACdrD,KAAKD,MAAMsD,MAAQ,IAEhBrD,KAAKF,OAAOG,cAGfD,KAAKC,cAAgBD,KAAKF,OAAOG,cAFjCD,KAAKC,cAAgB,IAIlBD,KAAKF,OAAOI,cAGfF,KAAKE,cAAgBF,KAAKF,OAAOI,cAFjCF,KAAKE,cAAgB,EAKzB,aAAMC,GACJ,aAAaH,KAAKsD,OAAOtD,KAAKD,MAAMkC,YAE5B,YAAMqB,CACdrB,GAEA,MAAMsB,QAAoBnF,EAAkB6D,EAAYjC,KAAKC,eACvDuD,QAAsBxD,KAAKJ,kBAC9B6D,gBAAgBzD,KAAKF,OAAOe,YAC5B6C,YAAY,CACXC,YAAa,kBACbJ,YAAaA,EACbF,MAAOrD,KAAKD,MAAMsD,MAClBO,gBAAiB,SACjBC,kBAAmB,GACnBC,oBAAqB,aAEtB1C,MACH,GAAIoC,EAAcnC,MAChB,MAAO,GAET,MAAM0C,EAAa,IAAIC,IACjBC,EAAiB,GACvB,IAAK,MAAMnD,KAAO0C,EAAcjC,KAAM,CACpC,MAAM2C,EACJpD,EAAIoD,OAGAC,EAAWD,EAAKjD,oBACjB8C,EAAWK,IAAID,KAClBJ,EAAWM,IAAIF,GACfF,EAAQ5B,KAAK6B,IAGjB,MAAMI,ECnEM,SACdL,EACA/C,GAEA,OAAO+C,EACJM,KAAKC,IACJ,MAAMC,EAAsB/B,EAC1BxB,EAAMgB,cACNsC,EAAOvC,WAAWC,gBAEbS,EAAGC,EAAG8B,EAAGC,EAAGC,EAAGC,EAAGC,EAAGC,EAAGhC,EAAGzB,GAAKJ,EAAMgB,cAMvC8C,EACJ,KAAQP,EANyB/B,EACjC,CAACC,EAAGC,EAAG8B,EAAGC,EAAGC,EAAGC,EAAGC,EAAGC,EAAGhC,EAAGzB,GAAG2D,UAAUC,KAAK,IAC9CV,EAAOvC,WAAWC,gBAKlB,KAHoB,EAAsB,GAAlBsC,EAAOW,UAIjC,MAAO,IAAKX,EAAQQ,aAAY,IAEjCI,MAAK,CAACzC,EAAGC,IAAMA,EAAEoC,WAAarC,EAAEqC,aAChCC,SACL,CD4CmBI,CAAgBpB,EAAShC,GAExC,OADmBqC,GE5EP,SAAAgB,EAAU3C,EAAQC,GAChC,GAAID,IAAMC,EAAG,OAAO,EAEpB,UAAWD,UAAaC,EAAG,OAAO,EAElC,GAAID,aAAa4C,EAAAA,WAAa3C,aAAa2C,YACzC,OAAO5C,EAAE6C,QAAQ5C,GAGnB,GAAID,GAAKC,GAAkB,iBAAND,GAA+B,iBAANC,EAAgB,CAC5D,MAAM6C,EAAQC,OAAOC,KAAKhD,GACpBiD,EAAQF,OAAOC,KAAK/C,GAE1B,GAAI6C,EAAMlH,SAAWqH,EAAMrH,OAAQ,OAAO,EAE1C,IAAK,MAAM4D,KAAOsD,EAAO,CACvB,IAAKG,EAAMC,SAAS1D,GAAM,OAAO,EACjC,IAAKmD,EAAU3C,EAAER,GAAMS,EAAET,IAAO,OAAO,EAGzC,OAAO,EAGT,OAAO,CACT,CChBO,MAAM2D,EACX5B,IAEA,MAAM6B,EAAS7B,EAAK6B,OAAO7B,OACrB8B,EAAQ9B,EAAK8B,MAAM9B,OAEnB+B,EAAgD,CAAE,EAClDC,EAA8C,CAAE,EAChDC,EAAgD,CAAE,EAExDT,OAAOC,KAAKK,GAAOI,SAASjE,IAC1B,MAAMkE,EAAWlE,EACXmE,EAAaN,EAAMK,GACnBE,EAAcR,EAAOM,QAEPG,IAAhBD,EACFL,EAAMG,GAAYC,EACRhB,EAAUgB,EAAYC,KAChCN,EAAQI,GAAYC,MAKxBZ,OAAOC,KAAKI,GAAQK,SAASjE,IAC3B,MAAMkE,EAAWlE,OACOqE,IAApBR,EAAMK,KACRF,EAAQE,GAAYN,EAAOM,OAY/B,MARe,CACbN,SACAC,QACAC,UACAC,QACAC,UAGW,sCCJb,WAAAxG,CACmBC,EACAE,EACAD,GAIjB,GANiBG,KAAiBJ,kBAAjBA,EACAI,KAAMF,OAANA,EACAE,KAAkBH,mBAAlBA,EAGjBG,KAAKJ,kBAAkB6G,SAAS,CAAEC,2BAA2B,IACzD1G,KAAKF,OAAOe,WAAWtC,OAAS,EAClC,MAAM,IAAIoI,MACR,8DAkBN,YAAMrD,CACJvD,GAEA,GAAgC,iBAArBA,EAAMkC,YAAuD,IAA5BlC,EAAMkC,WAAW1D,OAC3D,MAAM,IAAIoI,MAAM,0DAElB,aAAa,IAAIvD,EACfpD,KAAKJ,kBACLI,KAAKF,OACLC,GACAI,UAoBJ,aAAMyG,CAAQ7G,GACZ,GAAgC,iBAArBA,EAAMM,YAAuD,IAA5BN,EAAMM,WAAW9B,OAC3D,MAAM,IAAIoI,MAAM,0DAElB,aAAa,IAAIjH,EACfM,KAAKJ,kBACLI,KAAKH,mBACLG,KAAKF,OACLC,GACAI,UA6BJ,gBAAM0G,CAAWC,GAIf,aAAa,IAAInF,EACf3B,KAAKJ,kBACLI,KAAKH,mBACLG,KAAKF,QACLK,QAAQ2G,GAEZ,oBAAMC,CAAeC,EAAkBC,EAAe,WACpD,IAAKA,IAASA,EAAKC,WAAW,KAC5B,MAAM,IAAIP,MAAM,wCAgBlB,OAfAK,EAAI5F,IACF,GAAG6F,kBACH9I,MAAOgJ,EAAkBC,KACvB,MAAMC,YAAEA,GAAgBF,EAAQG,OAChC,IAAKD,IAAgBA,EAAY9I,QAAU8I,EAAY9I,OAAS,EAE9D,YADA6I,EAASG,KAAK,IAGhB,MAAM/C,QAAexE,KAAKsD,OAAO,CAC/BrB,WAAYoF,IAEdD,EAASG,KAAK/C,EACd,IAGGwC,EAcT,gBAAAQ,GAIE,OAAOrJ,MAAOsJ,EAAKC,KACjB,MAAML,EAAcI,EAAIvG,MAAMmG,YAC9B,IACGA,GACsB,iBAAhBA,GACPA,EAAY9I,OAAS,EAGrB,YADAmJ,EAAIH,KAAK,IAGX,MAAM/C,QAAexE,KAAKsD,OAAO,CAC/BrB,WAAYoF,IAEdK,EAAIH,KAAK/C,EACT,EAwBJ,aAAAmD,CACEC,GAEA,OAAOzJ,OAAS+F,OAAM2D,WACpB,GAAID,EAAc,CAEhB,UAD2BA,EAAaC,GAEtC,MAAM,IAAIC,EAAAA,WAAW,kBAAmB,gBAE5C,MAAMT,EAAcnD,EAAKmD,YACzB,IACGA,GACsB,iBAAhBA,GACPA,EAAY9I,OAAS,EAErB,MAAO,GAKT,aAHqByB,KAAKsD,OAAO,CAC/BrB,WAAYoF,GAED,EAsBjB,sBAAAU,CACEC,EACApG,EACAqG,EACAlI,EAGI,CAAE,EACNmI,EAA2C,IAE3C,OAAOF,EACL,IAAKE,EAAqBzF,SAAUwF,IACpC9J,MAAOgK,YACL,MAAMjE,EAAiB,QAAVkE,EAAAD,EAAMjE,YAAI,IAAAkE,OAAA,EAAAA,EAAElE,OACzB,IAAKiE,EAAMjE,OAASA,EAAM,OAE1B,MAAMmE,EAAoBnE,EAAKtC,EAAcI,YACvCzB,EAAsC,CAAE,EAC9C,IAAK,MAAM4B,KAAOP,EAAcQ,aAC1B8B,EAAK/B,IAAsB,IAAd+B,EAAK/B,MACpB5B,EAAe4B,GAAO+B,EAAK/B,IAG/B,GACEkG,GAC6B,iBAAtBA,GACPA,EAAkB9J,QAAiC,QAAvB+J,EAAAvI,EAAMG,qBAAiB,IAAAoI,EAAAA,EAAA,GAEnD,UACQtI,KAAK4G,QAAQ,IACd7G,EACHM,WAAYgI,EACZ9H,eAAgB,CACdU,oBAAqBkH,EAAMjE,KAAKzC,IAAIwF,QACjC1G,KAGP,MAAOgI,GAEP,YADAC,QAAQD,MAAMA,GAIlB,IAsBN,uBAAAE,CACEC,EACA9G,EACAqG,EACAlI,EAGI,CAAE,EACNmI,EAA2C,IAE3C,OAAOQ,EACL,IAAKR,EAAqBzF,SAAUwF,IACpC9J,MAAOgK,UACL,IAAKA,EAAMjE,KAAM,OACjB,MAAM+B,QAAEA,EAAOD,MAAEA,GAAUF,EAExBqC,EAAMjE,MACHmE,EAAoBpC,EAAQrE,EAAcI,YAC1CzB,EAAsC,CAAE,EAC9C,IAAK,MAAM4B,KAAOP,EAAcQ,aAC1B4D,EAAM7D,IAAuB,IAAf6D,EAAM7D,MACtB5B,EAAe4B,GAAO6D,EAAM7D,IAGhC,GACEkG,GAC6B,iBAAtBA,GACPA,EAAkB9J,QAAiC,QAAvB6J,EAAArI,EAAMG,qBAAiB,IAAAkI,EAAAA,EAAA,GAEnD,UACQpI,KAAK4G,QAAQ,IACd7G,EACHM,WAAYgI,EACZ9H,eAAgB,CACdU,oBAAqBkH,EAAMjE,KAAK8B,MAAMvE,IAAIwF,QACvC1G,KAGP,MAAOgI,GAEP,YADAC,QAAQD,MAAMA,GAIlB,IAgBN,wBAAAI,CACEC,EACAX,EACAC,EAA2C,CAAA,GAE3C,OAAOU,EACL,IAAKV,EAAqBzF,SAAUwF,IACpC9J,MAAOgK,UACL,MAAMjE,EAAiB,QAAVkE,EAAAD,EAAMjE,YAAI,IAAAkE,OAAA,EAAAA,EAAElE,OACzB,GAAKiE,EAAMjE,MAASA,EACpB,IACE,MAAMzD,EAAOT,KAAKJ,kBAAkBc,aAC9BO,EAAsBkH,EAAMjE,KAAKzC,IAAIwF,KACrC4B,QAAkB7I,KAAKJ,kBAC1BiB,WAAWb,KAAKF,OAAOe,YACvBM,MAAM,sBAAuB,KAAMF,GACnCG,MACH,IAAK,IAAI0H,EAAQ,EAAGA,EAAQD,EAAUtH,KAAKhD,OAAQuK,IAAS,CAC1D,MAAMhI,EAAM+H,EAAUtH,KAAKuH,GAC3BrI,EAAKe,OAAOV,EAAIW,KACZqH,EAAQ,WAAWrI,EAAKiB,cAExBjB,EAAKO,QACX,MAAOuH,GACP,OAGF"}